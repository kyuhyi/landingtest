/**
 * ============================================================
 * ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ Success í˜ì´ì§€
 * ============================================================
 *
 * ğŸ“ ëª©ì :
 * - ì„œë²„ì—ì„œ ë°œê¸‰í•œ Custom Tokenì„ ë°›ì•„ì„œ Firebaseì— ë¡œê·¸ì¸
 * - ë¡œê·¸ì¸ ì™„ë£Œ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
 *
 * ğŸ”„ ì „ì²´ íë¦„:
 * 1. URL íŒŒë¼ë¯¸í„°ì—ì„œ Custom Token ì¶”ì¶œ
 * 2. Firebase Client SDKë¡œ ë¡œê·¸ì¸ (signInWithCustomToken)
 * 3. ë¡œê·¸ì¸ ì„±ê³µ â†’ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
 * 4. ë¡œê·¸ì¸ ì‹¤íŒ¨ â†’ ì—ëŸ¬ í˜ì´ì§€ë¡œ ì´ë™
 *
 * âš ï¸ ì£¼ì˜ì‚¬í•­:
 * - ì´ í˜ì´ì§€ëŠ” í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ ('use client')
 * - useSearchParams ì‚¬ìš© ì‹œ ë°˜ë“œì‹œ Suspenseë¡œ ê°ì‹¸ì•¼ í•¨
 * - Custom Tokenì€ ì¼íšŒìš©ì´ë¯€ë¡œ í•œ ë²ˆë§Œ ì‚¬ìš© ê°€ëŠ¥
 */

'use client'

import { useEffect, Suspense } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import { signInWithCustomToken } from 'firebase/auth'
import { auth } from '@/lib/firebase'

// ============================================================
// ì‹¤ì œ ë¡œê·¸ì¸ ì²˜ë¦¬ ì»´í¬ë„ŒíŠ¸
// ============================================================
//
// ğŸ’¡ ì™œ ë³„ë„ ì»´í¬ë„ŒíŠ¸ë¡œ ë¶„ë¦¬í•˜ëŠ”ê°€?
// - useSearchParams()ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ Suspense ê²½ê³„ ë‚´ë¶€ì— ìˆì–´ì•¼ í•¨
// - Next.js 14+ì˜ ìš”êµ¬ì‚¬í•­
function KakaoSuccessContent() {
  const router = useRouter()
  const searchParams = useSearchParams()

  useEffect(() => {
    /**
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     *
     * ì‹¤í–‰ ì‹œì : ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ë˜ë©´ ì¦‰ì‹œ ì‹¤í–‰
     * ì‹¤í–‰ íšŸìˆ˜: 1íšŒ (ì˜ì¡´ì„± ë°°ì—´ì— searchParams, router)
     */
    const handleKakaoLogin = async () => {
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // STEP 1: URLì—ì„œ Custom Token ì¶”ì¶œ
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      //
      // URL í˜•ì‹: /auth/kakao/success?token=eyJhbGci...
      // searchParams.get('token')ìœ¼ë¡œ í† í° ê°’ ì¶”ì¶œ
      const token = searchParams.get('token')

      // í† í°ì´ ì—†ìœ¼ë©´ ì—ëŸ¬ (ë¹„ì •ìƒì ì¸ ì ‘ê·¼)
      if (!token) {
        console.error('âŒ Custom Tokenì´ ì—†ìŠµë‹ˆë‹¤.')
        router.push('/login?error=no_token')
        return
      }

      try {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // STEP 2: Firebase Client SDKë¡œ ë¡œê·¸ì¸
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        //
        // ğŸ“Œ signInWithCustomTokenì´ë€?
        // - ì„œë²„ì—ì„œ ë°œê¸‰í•œ Custom Tokenìœ¼ë¡œ Firebaseì— ë¡œê·¸ì¸í•˜ëŠ” í•¨ìˆ˜
        // - Admin SDKì˜ createCustomToken()ê³¼ ì§ì„ ì´ë£¨ëŠ” í•¨ìˆ˜
        //
        // ğŸ”„ ë‚´ë¶€ ë™ì‘:
        // 1. Firebase ì„œë²„ì— Custom Token ì „ì†¡
        // 2. Firebaseê°€ í† í° ê²€ì¦
        // 3. ìœ íš¨í•˜ë©´ ID Tokenê³¼ Refresh Token ë°œê¸‰
        // 4. ë¡œê·¸ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ (auth.currentUser)
        //
        // ğŸ’¡ ë¡œê·¸ì¸ í›„ ìë™ìœ¼ë¡œ:
        // - auth.currentUserê°€ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë¡œ ì„¤ì •ë¨
        // - onAuthStateChanged ë¦¬ìŠ¤ë„ˆê°€ íŠ¸ë¦¬ê±°ë¨
        // - ì„¸ì…˜ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë¨ (IndexedDB)
        console.log('ğŸ”¥ Firebase Custom Tokenìœ¼ë¡œ ë¡œê·¸ì¸ ì‹œì‘')

        const userCredential = await signInWithCustomToken(auth, token)

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ë¡œê·¸ì¸ ì„±ê³µ!
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        console.log('âœ… Firebase ë¡œê·¸ì¸ ì„±ê³µ:', userCredential.user.uid)
        console.log('ğŸ“§ ì´ë©”ì¼:', userCredential.user.email)
        console.log('ğŸ‘¤ ì´ë¦„:', userCredential.user.displayName)
        console.log('ğŸ“· í”„ë¡œí•„ ì‚¬ì§„:', userCredential.user.photoURL)

        // ğŸ“¦ userCredential.user êµ¬ì¡°:
        // {
        //   uid: "kakao_3740123456",
        //   email: "hong@kakao.com",
        //   displayName: "í™ê¸¸ë™",
        //   photoURL: "http://...",
        //   emailVerified: false,
        //   isAnonymous: false,
        //   metadata: {
        //     creationTime: "...",
        //     lastSignInTime: "..."
        //   },
        //   providerData: [...],
        //   ...
        // }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // STEP 3: ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        //
        // ğŸ’¡ ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€:
        // - Firebaseê°€ ìë™ìœ¼ë¡œ ì„¸ì…˜ ê´€ë¦¬
        // - ìƒˆë¡œê³ ì¹¨í•´ë„ ë¡œê·¸ì¸ ìœ ì§€ë¨
        // - ë¡œê·¸ì•„ì›ƒí•˜ê¸° ì „ê¹Œì§€ ê³„ì† ìœ íš¨
        //
        // ğŸ”„ ì „ì—­ ìƒíƒœ ì—…ë°ì´íŠ¸:
        // - auth.currentUserê°€ ì„¤ì •ë¨
        // - ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ onAuthStateChangedë¡œ ê°ì§€ ê°€ëŠ¥
        // - ë³´í˜¸ëœ í˜ì´ì§€ ì ‘ê·¼ ê°€ëŠ¥
        router.push('/')

      } catch (error: any) {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ë¡œê·¸ì¸ ì‹¤íŒ¨ ì²˜ë¦¬
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        //
        // ğŸ› ì£¼ìš” ì—ëŸ¬ ì¼€ì´ìŠ¤:
        // 1. auth/invalid-custom-token: í† í° í˜•ì‹ì´ ì˜ëª»ë¨
        // 2. auth/custom-token-mismatch: í”„ë¡œì íŠ¸ ID ë¶ˆì¼ì¹˜
        // 3. Network error: ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¬¸ì œ
        //
        // ğŸ’¡ ë””ë²„ê¹…:
        // - error.code: Firebase ì—ëŸ¬ ì½”ë“œ
        // - error.message: ì—ëŸ¬ ë©”ì‹œì§€
        console.error('âŒ Firebase ë¡œê·¸ì¸ ì‹¤íŒ¨:', error)
        console.error('   ì—ëŸ¬ ì½”ë“œ:', error.code)
        console.error('   ì—ëŸ¬ ë©”ì‹œì§€:', error.message)

        router.push('/login?error=firebase_signin_failed')
      }
    }

    // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ì¦‰ì‹œ ë¡œê·¸ì¸ ì²˜ë¦¬ ì‹¤í–‰
    handleKakaoLogin()

  }, [searchParams, router])
  // ì˜ì¡´ì„± ë°°ì—´:
  // - searchParams: URL íŒŒë¼ë¯¸í„°ê°€ ë³€ê²½ë˜ë©´ ì¬ì‹¤í–‰
  // - router: Next.js ë¼ìš°í„° ê°ì²´ (ì•ˆì •ì ì´ë¯€ë¡œ ì¬ì‹¤í–‰ íŠ¸ë¦¬ê±° ì•ˆ ë¨)

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ë¡œë”© í™”ë©´ UI
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //
  // ğŸ’¡ ì‚¬ìš©ì ê²½í—˜ (UX):
  // - ë¡œê·¸ì¸ ì²˜ë¦¬ëŠ” ë³´í†µ 1-2ì´ˆ ì†Œìš”
  // - ë¡œë”© í™”ë©´ìœ¼ë¡œ ì§„í–‰ ìƒíƒœ í‘œì‹œ
  // - ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ì‹œê°ì  í”¼ë“œë°± ì œê³µ
  return (
    <div className="min-h-screen flex items-center justify-center bg-bsd-dark">
      <div className="text-center">
        {/* íšŒì „í•˜ëŠ” ìŠ¤í”¼ë„ˆ */}
        <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-bsd-blue-500 mx-auto mb-4"></div>
        {/* ì•ˆë‚´ ë©”ì‹œì§€ */}
        <p className="text-white text-lg">ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...</p>
        <p className="text-gray-400 text-sm mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”</p>
      </div>
    </div>
  )
}

// ============================================================
// ë©”ì¸ ì»´í¬ë„ŒíŠ¸ (Suspenseë¡œ ê°ì‹¸ê¸°)
// ============================================================
//
// ğŸ“Œ Suspenseë€?
// - React 18+ì˜ ê¸°ëŠ¥ìœ¼ë¡œ, ë¹„ë™ê¸° ì‘ì—… ì¤‘ ëŒ€ì²´ UI í‘œì‹œ
// - Next.js 14+ì—ì„œ useSearchParams() ì‚¬ìš© ì‹œ í•„ìˆ˜
//
// ğŸ’¡ ì™œ í•„ìš”í•œê°€?
// - useSearchParams()ëŠ” ë™ì  ë°ì´í„°ë¥¼ ì½ìŒ
// - Next.jsëŠ” Server Componentsë¥¼ ìš°ì„  ì‚¬ìš©
// - ë™ì  ë°ì´í„°ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥
// - Suspenseë¡œ ê°ì‹¸ì„œ ìŠ¤íŠ¸ë¦¬ë° ë Œë”ë§ í™œì„±í™”
//
// ğŸ”„ ë Œë”ë§ ìˆœì„œ:
// 1. ì„œë²„: Suspense fallback ë Œë”ë§
// 2. í´ë¼ì´ì–¸íŠ¸: í•˜ì´ë“œë ˆì´ì…˜
// 3. useSearchParams() ì‚¬ìš© ê°€ëŠ¥
// 4. KakaoSuccessContent ë Œë”ë§
export default function KakaoSuccessPage() {
  return (
    <Suspense
      fallback={
        // Suspense ëŒ€ì²´ UI (ì´ˆê¸° ë¡œë”© í™”ë©´)
        <div className="min-h-screen flex items-center justify-center bg-bsd-dark">
          <div className="text-center">
            <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-bsd-blue-500 mx-auto mb-4"></div>
            <p className="text-white text-lg">ë¡œë”© ì¤‘...</p>
          </div>
        </div>
      }
    >
      {/* ì‹¤ì œ ë¡œê·¸ì¸ ì²˜ë¦¬ ì»´í¬ë„ŒíŠ¸ */}
      <KakaoSuccessContent />
    </Suspense>
  )
}

/**
 * ============================================================
 * í•™ìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸
 * ============================================================
 *
 * âœ… ì´í•´í•´ì•¼ í•  í•µì‹¬ ê°œë…:
 *
 * 1. Custom Token ë¡œê·¸ì¸
 *    - ì„œë²„ì—ì„œ ë°œê¸‰í•œ í† í°ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë¡œê·¸ì¸
 *    - signInWithCustomToken() í•¨ìˆ˜ ì‚¬ìš©
 *    - ì¼íšŒìš© í† í° (í•œ ë²ˆë§Œ ì‚¬ìš© ê°€ëŠ¥)
 *
 * 2. Firebase Auth State
 *    - auth.currentUser: í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
 *    - onAuthStateChanged: ë¡œê·¸ì¸ ìƒíƒœ ë³€ê²½ ê°ì§€
 *    - ì„¸ì…˜ ìë™ ìœ ì§€ (IndexedDBì— ì €ì¥)
 *
 * 3. Next.js useSearchParams
 *    - URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì½ê¸°
 *    - Suspense ê²½ê³„ ë‚´ë¶€ì—ì„œ ì‚¬ìš© í•„ìˆ˜
 *    - í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥
 *
 * 4. React useEffect
 *    - ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ì‹¤í–‰
 *    - ì˜ì¡´ì„± ë°°ì—´ë¡œ ì¬ì‹¤í–‰ ì¡°ê±´ ì œì–´
 *    - ë¹„ë™ê¸° ì‘ì—… ì²˜ë¦¬
 *
 * 5. ì‚¬ìš©ì ê²½í—˜ (UX)
 *    - ë¡œë”© ìƒíƒœ í‘œì‹œ
 *    - ì—ëŸ¬ ì²˜ë¦¬ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸
 *    - ë¶€ë“œëŸ¬ìš´ í™”ë©´ ì „í™˜
 *
 * ============================================================
 * ì¶”ê°€ í•™ìŠµ ì£¼ì œ:
 * ============================================================
 *
 * 1. onAuthStateChanged ë¦¬ìŠ¤ë„ˆ
 *    - ì „ì—­ ë¡œê·¸ì¸ ìƒíƒœ ê´€ë¦¬
 *    - Context APIì™€ ì—°ë™
 *    - ë³´í˜¸ëœ ë¼ìš°íŠ¸ êµ¬í˜„
 *
 * 2. Firebase Auth ì„¸ì…˜ ê´€ë¦¬
 *    - Session Persistence ì„¤ì •
 *    - Refresh Token ìë™ ê°±ì‹ 
 *    - ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
 *
 * 3. ì—ëŸ¬ ì²˜ë¦¬ ê³ ë„í™”
 *    - ì—ëŸ¬ íƒ€ì…ë³„ ì•ˆë‚´ ë©”ì‹œì§€
 *    - ì¬ì‹œë„ ë¡œì§
 *    - ì—ëŸ¬ ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§
 *
 * 4. Next.js Suspense
 *    - Streaming SSR
 *    - Progressive Hydration
 *    - Error Boundary ì—°ë™
 */
